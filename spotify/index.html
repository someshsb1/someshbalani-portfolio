<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify – Get User Profile</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 28px; line-height: 1.35; }
    h1 { margin: 0 0 8px 0; }
    .buttons { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 12px 0 18px; }
    button { padding: 10px 16px; border-radius: 10px; border: 1px solid #d0d0d0; cursor: pointer; background: transparent; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 14px; }
    .row { display: flex; gap: 14px; align-items: center; }
    .hidden { display: none; }
    img.avatar { width: 84px; height: 84px; border-radius: 50%; object-fit: cover; }
    .muted { opacity: .75; }
    a { text-decoration: none; }
  </style>
</head>
<body>
  <h1>Spotify: Get User Profile</h1>
  <div class="muted">Demo on someshbalani.com — PKCE, no backend</div>

  <div class="buttons">
    <button id="loginBtn">Log in with Spotify</button>
    <button id="logoutBtn" class="hidden">Log out</button>
  </div>

  <div id="status" class="muted"></div>

  <div id="profile" class="card hidden" style="margin-top:16px;">
    <h3 style="margin:0 0 10px;">Your Spotify Profile</h3>
    <div id="profileCard"></div>
  </div>

  <script>
  // ===== CONFIG =====
  // Use your actual Client ID and exact redirect URI you registered:
  const CLIENT_ID   = "633ae324f0cd47d184d021cb0d35b598";
  const REDIRECT_URI = "https://someshbalani.com/spotify/callback/";
  // Scopes needed to mirror the example; email is useful to display:
  const SCOPES = ["user-read-email"].join(" ");

  // ===== Utilities: PKCE + token storage =====
  function b64url(buffer) {
    return btoa(String.fromCharCode(...new Uint8Array(buffer)))
      .replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");
  }
  async function pkcePair() {
    const bytes = crypto.getRandomValues(new Uint8Array(64));
    const verifier = Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
    const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier));
    const challenge = b64url(digest);
    return { verifier, challenge };
  }

  const tokenKey = "spotify_token";
  const refreshKey = "spotify_refresh";

  function getAccessToken() {
    try { return JSON.parse(localStorage.getItem(tokenKey) || "null"); }
    catch { return null; }
  }
  function setTokens(accessToken, refreshToken) {
    if (accessToken) localStorage.setItem(tokenKey, JSON.stringify(accessToken));
    if (refreshToken) localStorage.setItem(refreshKey, JSON.stringify(refreshToken));
  }
  function clearTokens() {
    localStorage.removeItem(tokenKey);
    localStorage.removeItem(refreshKey);
  }

  // ===== API helper (handles refresh-once) =====
  async function refreshIfNeeded(resp) {
    if (resp.status !== 401) return resp;
    const rt = JSON.parse(localStorage.getItem(refreshKey) || "null");
    if (!rt) return resp;

    const body = new URLSearchParams({
      grant_type: "refresh_token",
      refresh_token: rt,
      client_id: CLIENT_ID,
    });
    const r = await fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded"},
      body
    });
    if (!r.ok) return resp;
    const data = await r.json();
    if (data.access_token) {
      setTokens(data.access_token, data.refresh_token || rt);
      return null; // signal to retry with new token
    }
    return resp;
  }

  async function api(path, init = {}) {
    const base = "https://api.spotify.com/v1";
    const url = path.startsWith("http") ? path : `${base}${path.startsWith("/") ? "" : "/"}${path}`;
    const headers = { ...(init.headers||{}), ...(getAccessToken() ? { Authorization: `Bearer ${getAccessToken()}` } : {}) };
    let resp = await fetch(url, { ...init, headers });

    if (resp.status === 401) {
      const maybe = await refreshIfNeeded(resp);
      if (maybe === null) {
        const headers2 = { ...(init.headers||{}), ...(getAccessToken() ? { Authorization: `Bearer ${getAccessToken()}` } : {}) };
        resp = await fetch(url, { ...init, headers: headers2 });
      }
    }
    if (!resp.ok) {
      const txt = await resp.text().catch(() => "<no body>");
      console.error("Spotify API error:", resp.status, url, txt);
      throw new Error(`Spotify API error: ${resp.status}`);
    }
    return resp.json();
  }

  // ===== UI wiring =====
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const statusBox = document.getElementById("status");
  const profileWrap = document.getElementById("profile");
  const profileCard = document.getElementById("profileCard");

  function setLoggedInUI(isLoggedIn) {
    loginBtn.classList.toggle("hidden", isLoggedIn);
    logoutBtn.classList.toggle("hidden", !isLoggedIn);
  }

  function renderProfile(p) {
    const img = (p.images && p.images[0] && p.images[0].url) || "";
    profileCard.innerHTML = `
      <div class="row">
        ${img ? `<img class="avatar" src="${img}" alt="avatar" />` : ""}
        <div>
          <div><strong>${p.display_name || "(no display name)"}</strong> <span class="muted">(${p.id})</span></div>
          ${p.email ? `<div>${p.email.replace(/</g,"&lt;")}</div>` : ""}
          <div>Country: ${p.country || "—"} • Product: ${p.product || "—"}</div>
          <div style="margin-top:6px;"><a href="${p.external_urls?.spotify}" target="_blank" rel="noopener">Open Spotify Profile</a></div>
        </div>
      </div>
    `;
    profileWrap.classList.remove("hidden");
  }

  async function loadProfile() {
    statusBox.textContent = "Loading profile…";
    const me = await api("/me");      // ← this is the example's main call
    console.log("ME:", me.id, me.display_name);
    renderProfile(me);
    statusBox.textContent = "Loaded.";
  }

  async function login() {
    const { verifier, challenge } = await pkcePair();
    sessionStorage.setItem("pkce_verifier", verifier);

    const url = new URL("https://accounts.spotify.com/authorize");
    url.search = new URLSearchParams({
      client_id: CLIENT_ID,
      response_type: "code",
      redirect_uri: REDIRECT_URI,
      scope: SCOPES,
      code_challenge_method: "S256",
      code_challenge: challenge
    });
    window.location = url.toString();
  }

  loginBtn.addEventListener("click", login);
  logoutBtn.addEventListener("click", () => {
    clearTokens();
    profileWrap.classList.add("hidden");
    profileCard.innerHTML = "";
    statusBox.textContent = "Logged out.";
    setLoggedInUI(false);
  });

  // Auto-load if we already have a token
  if (getAccessToken()) {
    setLoggedInUI(true);
    loadProfile().catch(e => {
      statusBox.textContent = "Could not load profile. Try Log out → Log in.";
      console.error(e);
    });
  } else {
    setLoggedInUI(false);
  }
  </script>
</body>
</html>
